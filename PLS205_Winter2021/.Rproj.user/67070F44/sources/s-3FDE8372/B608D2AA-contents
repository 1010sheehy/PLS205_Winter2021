---
title: "HW6"
output:
  html_document:
    df_print: paged
    toc: yes
  html_notebook:
    number_sections: yes
    toc: yes
    toc_float: yes
---
Use this R Notebook document to answer the questions and document your work. 
Enter the R code used to answer each question in the corresponding R code chunk. 
Write any textual explanations **outside** of the chunks. When we grade, we will *hide* the code and just look at the R output and your written answers.
Attempt to clean up your code as much as possible so that only the necessary lines remain. 

When you are done:

1. Select 'Run All' from the 'Run' dropdown menue.
2. Save (File -> Save)
3. Click 'Preview' to bring up the `HW1.nb.html` file. Check through this to make sure it rendered correctly.
4. Upload the `HW1.nb.html` to Canvas.


Necessary libraries
```{r echo = F,message=FALSE, warning=FALSE} 
# Necessary pacakges 
library(ggplot2) 
library(emmeans)
# the following 4 packages are new. You may have to install these using install.packages(c('car','lme4','lmerTest','pbkrtest'))
library(car)
library(lme4)
library(lmerTest)
library(pbkrtest)
```

## Question 1

A researcher was interested in examining the effect of pasture species composition on beta-carotene content in eggs of pastured poultry. 
She evenly divided each of four fields into five sections and overseeded each section with one of the following: 
1) annual rye (grass); 2) fescue (grass); 3) white clover (legume); 4) vetch (legume); or, 5) clover/fescue mix. 
A separate flock of 10 birds was put out in each section. 
After one-week, eggs from each flock were collected daily and combined for determining beta-carotene content of the yolks. 
These values in $\mu g/g$ were averaged after 10 days and are presented below. 

| Field | P1 - Rye | P2 - Fescue | P3 - Clover | P4 - Vetch | P5 - Mix |
|:-----:|:--------:|:-----------:|:-----------:|:----------:|:--------:|
|   F1  |   3.63   |     3.49    |     3.84    |    4.60    |   5.32   |
|   F2  |   3.81   |     4.30    |     4.65    |    5.50    |   4.79   |
|   F3  |   2.97   |     3.26    |     4.16    |    3.85    |   5.13   |
|   F4  |   4.08   |     4.15    |     4.19    |    5.06    |   4.52   |

```{r echo=FALSE}
data_1 = read.csv('egg_carotene.csv')
str(data_1)
```

### 1.1 Describe the design of this experiment in detail.

**Design**: 
**Response**: 

| Structure | Variable    | Type        | # levels | Experimental Unit |
|-----------|-------------|-------------|----------|-------------------|
|Treatment  |Species      | Factor      |    5     |       Section     |
|Design     | Field       |Factor       |    4     |                   |
|Design     | Section     |Factor       |    20    |                   |
|Design     |Species:Field|Factor       |    20    |                   |
|Response   | Beta        |  Num        |    20    |                   |


> This is an RCBD. The treatment is the species of plant being applied to each subsection of the field. The EU is the section of the field the treatment is applied to, which is also an alias of the flock which is also an alias of the species:block interaction. The field is the block unit we'll be using so I called it Block. Lastly, our response variable is the beta carotene level of the eggs produced in each flock/section. 


### 1.2 Assess whether the assumptions of a linear model are adequately satisfied. Is a transformation needed?
    
```{r}
#corrections of the data first
#interaction for section:species
data_1$sample <- interaction(data_1$Field,data_1$Species,drop = TRUE)
data_1$Section<-as.factor(data_1$Section)

#write a model
model<-lm(Beta ~ Species + Field, data=data_1)
par(mfrow=c(1,2))
plot(model,which=2:3)


#looks bad, want to transform with log base 10
data_1$log10Beta<-log10(data_1$Beta)
transf_model<-lm(log10Beta ~ Species + Field, data=data_1)
par(mfrow=c(1,2))
plot(transf_model,which=2:3)


```

> This is a multiplicative interaction based on the U in the scale location plot. That violates our two-way ANOVA assumption of additivity and could lead to possible misleading F-tests. Because of this, I have applied a log (base 10) transformation on the data. The diagnostic plots only marginally improved from that transformation, but the readings on Canvas say that's the primary correction for multiplicative data, so...I tried! Moved forward with the transformed data since that's what the lit. said to do. 


### 1.3 Estimate the differences between all pairs of pasture covers. Include appropriate units based on your choice of transformation (or no transformation)

```{r}
#pairwise analysis overall
model_means = emmeans(transf_model,spec = 'Species')
summary(contrast(model_means,'pairwise'),infer=T)

#pairwise analysis including field as an interactive term
#means = emmeans(transf_model,specs = c('Field','Species'))
#contrasts_by_Species = contrast(means,method='pairwise',by='Field')
#summary(contrasts_by_Species,infer=T,level = 1-(0.05/5))  # Bonferroni adjustment for 5 tables of contrasts (one for each species)

#detransform the data to interpret it in units
detransformed_means_table = as.data.frame(summary(contrast(model_means,'pairwise'),infer=T))
detransformed_means_table$estimate = 10^(detransformed_means_table$estimate)
detransformed_means_table$lower.CL = 10^(detransformed_means_table$lower.CL)
detransformed_means_table$upper.CL = 10^(detransformed_means_table$upper.CL)
detransformed_means_table
```

> The differences are estimated above. Because the data is log10 transformed, we have to detransform the data in order to get real units. The detransformed data table above shows the contrasts between species in each field. The units are back to mean grams beta/grams total. There seem to be three significant pairwise comparisons: Species 1 - Species 4; Species 1 - Species 5; Species 2 - Species 5. 

### 1.4 Is there any evidence of an interaction between Field and Species cover? ie. do differences among covers change across the fields?
Is the interaction replicated? If not, you can't answer this question with an ANOVA, but you can tentatively assess with an interaction plot. 
```{r}
#no replication so we cannot answer this with anova
#test with an interaction plot
# first get the block means
block_means = aggregate(Beta~Field,data_1,FUN=mean)
# order the table of block_means
block_means = block_means[order(block_means$Beta),]
block_means
#mean beta per block & ordered it from lowest to highest

library(ggplot2)
# now, re-order the levels of `Block` in order of the block means
data_1$Block = factor(data_1$Field,levels = block_means$Field)
ggplot(data_1,aes(x=Block,y=Beta)) +
geom_line(aes(group=Species,color =Species))

```

> Yes, we can see that the effect of species on beta varies as a function of field in this plot. Specifically, the effect of species is more variable in F4 and F2, suggesting there is likely a multiplicative effect of Block:Species.


### 1.5 Did the researcher gain information by utilizing a RCBD relative to a CRD where the sections of all fields were randomized together?
```{r}
#make a model of the same data without any blocking
model2<-lm(log10Beta ~ Species, data=data_1)
par(mfrow=c(1,2))
plot(model2,which=2:3)

#made both transformed so I can compare 1:1 without detransforming all the units again
#anovas 
anova(transf_model)
anova(model2)

```

> I tested a "nonblocked" CRD model using the same data and compared their effects. The p-value for species is more significant in the blocked model which is positive. The most telling part is looking at the MSE for each model. We can see that, even though those values are very close together, the MSE of the CRD model is basically 150% the value of the blocked model. That's why we see the corresponding F statistic (MST/MSE) for the CRD is smaller (less significant) than the F statistic for the RCBD. 
>That said, if we look at the original data and interpret it in a biological sense, the variance within the whole dataset is very small. The difference between the most extreme Beta values is only ~ 0.8 g beta per gram egg. I would argue that this is a case where we have to consider the distinction between statistical significance vs. biological significance. The RCBD seems to be more significant statistically but if the biological inference is that 0.8 is basically no difference between beta carotene value, we might not care about that small confounding effect enough to spend money on a blocking structure.

### 1.6 Instead of randomizing all 5 plots on the 4 fields together, speculate on the efficiency had she used only one field.
In this case, to maintain the same replication, she would divide it into 20 smaller plots, and use only 2 birds per plot (instead of 10).
Speculate on how the MSE would compare to the original RCBD, or the CRD over the four fields. 
**Is there any advantage to spreading the experiment over 4 fields** Is there any disadvantage?

>The answer to this question depends on the field that the researcher chooses AND the variability in the 2 chickens. IF we picked a field that was VERY homogenous across the field, we might expect that the variance among plots would go down. That said, because we're only using 2 birds per plot, there is potential that our average per plot will be more variable due to biological variability in chickens. The variability that results from these two features will determine whether the estimated variance in numerator of the MSE equation is higher or lower. 
>At the same time, the denominator of the MSE equation, which is DfE, will be larger for the new experiment relative to the RCBD (15 vs 12), but equal to the denominator/DfE of the CRD. 
> With the RCBD experiment, we have a low variance since we've taken the variability of "field" out of the residuals & our DfE is 12. For the CRD experiment, our variance is slightly higher since it now includes the field level variability again, so that's not as good, but also our DfE is now 15. In this new single-field scenario, our variance could be higher or lower relative to the other experiments, but also our DfE would still be 15 since we're not including blocking. If the single field reduces the variance, then the MSE would be the lowest, but if it increases the variance, it may not be the case.

>Spreading the experiment over 4 fields may still have an advantage, depending on the study question and the reference population we're concerned with. If we want to generalize our findings on plant species efficacy in ALL agricultural land (which encompasses many gradients of abiotic/biotic conditions), we may want to be sure that our "section" samples are representative of a bunch of different conditions. In that case, intentional blocking may be useful. If we're not concerned with that kind of application and are purely interested from a biochem standpoint, there probably isn't value in replicating over four fields. A potential disadvantage is that using multiple fields is labor intensive and requires more resources. We also would increase our df which may negatively affect the size of our confidence intervals/decrease our precision.


### 1.7 Add 1 $\mu g/g$ to each value in Field F4. Does this produce any effect on the SS_Field, MS_Field, or F-value? Explain why or why not in one sentence.
In this case (with Field F4 being much more productive), did the importance of Blocking increase or decrease?

The following code makes a modifed dataset with the increase of 1 in the Beta values for Field F4

```{r}
data_2_modified = data_1
data_2_modified$Beta[data_2_modified$Field == 'F4'] = data_2_modified$Beta[data_2_modified$Field == 'F4'] + 1

data_2_modified$log10Beta<-log10(data_2_modified$Beta)

#new models
rcbdnew<-lm(log10Beta ~ Species + Field, data_2_modified)

anova(transf_model)
anova(rcbdnew)

```

> SSField, MSField, and F-Value all increased with the new data set because there is now greater variability among the fields. In this case, the importance of blocking increased & generally speaking the greater the variability across the sampling region, the more important it is to block.