---
title: "HW5"
output:
  html_document:
    df_print: paged
---

```{r}
library(ggplot2)
library(ggplot2)
library(emmeans)
```


# Question 1

Consider the same experiment that you studied in HW4:

> To study the effect of burial time on germination and dormancy of *Hordeum murinum ssp. leporinum* (Hare Barley), 
> overwintering seeds were placed in bags in a field, and then removed and tested at six time intervals (0, 30, 60, 90, 120, and 150 days after > burial). The design was a completely randomized design, with 5 replicate bags per burial time.
> Each bag contained 200 seeds. At the designed time, each bag was opened, and then the seeds were split evenly between two 
> germination trays, and the number of germinating seeds was measured in each tray.

Considering what we discussed in lecture this week, re-consider your choice over experimental units. 
Is "Bag" really an appropriate experimental unit for the effect of burial time?

## 1 Provide a critique of this experimental design
Start by re-making the design table, and carefully considering the experimental units.
Is it sufficient to answer the intended question?

**Design**: Completely randomized design

| Structure | Variable     | Type        | # levels | Experimental Unit |
|-----------|--------------|-------------|----------|-------------------|
|Treatment  |Burial Time   |Factor/Num   | 6        | Bag-time-group    |
|Design     |Bag-time group|Factor       | 6        |                   |
|Design     |Bags          |Factor       |  30      |                   |
|Design     |Trays/sub     |Factor       |  60      |                   |
|Response   |Germinates    |Numeric      |  60      |                   | 

> Previously, we did not consider that EU's must be interspersed temporally & spatially for all stages of the experiment. Because our groups of bags (5 bags in 6 distinct time groups) are treated as units at some stages of the experiment (particularly removal from the ground), they cannot be considered temporally independent of eachother, so we'll consider each group of bags to be one EU. Individual bags are replicates of bag-time-group, and the trays are sub-samples of the bags. 

## 2 What would you recommend to the researcher in terms of how she should report the results?
What type of analysis would you recommend?
How should they interpret the treatment effect they observe?
> This is an example of pseudoreplication! There is only one replicate of each treatment EU. The researcher *could* (but shouldn't) run the same analyses we did last time (aggregating, lmer model, contrast & trt.vs.ctrl functions) but the values & CI's they would get from those analyses would be of their subsamples, not of their EU's. Thus when they went to interpret the results, only the means of the subsamples should be reported, the other values do not answer the question itself about the EU's. Really all you can safely report from this data set are the mean germinates per EU group without any estimates of error or quality. 

>I would recommend instead that the experimenters run the experiment through multiple times (preferally in independent plots) so that they can increase the replicates of the EUs (groups of bags) and actually run the analysis on the EU's themselves. 

# Question 2

A researcher conducted a study comparing the effect of different ground covers on nitrous oxide fluxes from apple orchard soils. She randomly assigned the inter-row spaces of an orchard block to one of four treatments: 1) no cover (Bare); 2) fescue (Grass); 3) white clover (Legume); and, 4) fescue-clover mix (Mix). Each treatment level was replicated in 6 plots. After rain events, emissions were collected from each plot, analyzed, and the emitted nitrous oxide was calculated in g N~2~O ha^-1^ d^-1^. Average emissions for each plot are reported below.

| Rep |  Bare | Grass | Legume |  Mix  |
|:---:|:-----:|:-----:|:------:|:-----:|
|  1  | 44.79 | 21.59 |  20.08 | 21.48 |
|  2  | 53.71 | 21.58 |  16.76 | 24.46 |
|  3  | 68.69 | 25.73 |  15.15 | 25.47 |
|  4  | 70.46 | 32.08 |  17.72 | 27.02 |
|  5  | 88.11 | 27.60 |  15.13 | 18.52 |
|  6  | 95.53 | 22.11 |  19.98 | 21.54 |

```{r echo=FALSE}
NO_data = read.csv('HW5_data.csv')
str(NO_data)
NO_data$Plot <- as.factor(NO_data$Plot)
```

## 3 Describe the design of this experiment in detail.

**Design**: Completely randomized design

| Structure | Variable   | Type        | # levels | Experimental Unit |
|-----------|------------|-------------|----------|-------------------|
|Treatment  | Covercrop  |Factor       |   4      | Plot              |
|Design     |Plot        |Factor       |  24      |                   |
|Response   | N20        |Numeric      |  24      |                   |

## 4 Test the necessary assumptions of ANOVA. Report on the results.

```{r}
#just look at the data
plot(Flux ~ Cover, data=NO_data)

#now test assumptions
par(mfrow=c(1,2))
cover_model <- lm(Flux ~ Cover, data=NO_data)
plot(cover_model, which=c(2:3))

```

> These are not great! The QQ plot has a ton of values above and below the line which suggests that our data are not normal distributed. Similarly, the residuals plot shows that we have more variation in the higher values, suggesting variance is not homogenous across the groups.

## 5 Perform an appropriate transformation of the data. Re-check the assumptions of ANOVA, and report the results.

```{r}
#log transformation the mechanical way
NO_data$logflux<-log(NO_data$Flux)
transformed_flux_model<-lm(logflux ~ Cover, NO_data)

#or the direct method
direct_transformed_model = lm(log(Flux)~Cover,NO_data)

par(mfrow=c(1,2))
plot(direct_transformed_model, which=c(2:3))


```

> This is one possible & appropriate transformation (log base e). By applying the transformation we have improved how normally distributed the data are. The scale location plot doesn't seem to have improved very much though, so we may still not be able to assume homogeneity of variancea across groups. Essentially - better than before, but not perfect.

## 6 Provide estimates of effects of the various ground covers relative to Bare ground on both the original and transformed data ($\alpha = 0.05$). 
Describe and compare the results of both models. Be sure to provide units for the effect sizes on both scales. 

```{r}
#trt vs control for untransformed & transformed

#first with original data
means_original = emmeans(cover_model,specs = 'Cover')  # This preps an emmeans analysis, grouping by cover type
orig_trt_vs_control = contrast(means_original,method = 'trt.vs.ctrl',ref = 1) 
summary(orig_trt_vs_control,level = 0.95,infer = c(T,F))
summary(orig_trt_vs_control,level = 0.95,infer = c(F,T))

##do it again with transformed data
means_trans = emmeans(transformed_flux_model,specs = 'Cover')
trans_trt_vs_control = contrast(means_trans,method = 'trt.vs.ctrl',ref = 1) 
summary(trans_trt_vs_control,level = 0.95,infer = c(T,F))
summary(trans_trt_vs_control,level = 0.95,infer = c(F,T))

```

> For our original data, we get the following effect sizes relative to the control - grass emitted 45 N20/ha/day less than the bare ground, Legumes emitted 52.7 N20/ha/day less than bare ground, and the mix emitted 47.1 less N20/ha/day. The p-values for these comparisons were very high, <0.0001 (those p-values remained high for both the original & the transformed data). 

>For our transformed data, we find that grass emitted 1.01% less N20/ha/day than the bare ground, legumes emitted 1.36% less, and the mix emitted 1.09% less. 


## 7 Provide estimates and confidence intervals for the means of the 4 treatments.
**Are the means greater or less than the means estimated on the un-transformed scale?**

```{r}
#detransform now
means_trans
detransformed_means_table = as.data.frame(means_trans)
detransformed_means_table$emmean = exp(detransformed_means_table$emmean)
detransformed_means_table$lower.CL = exp(detransformed_means_table$lower.CL)
detransformed_means_table$upper.CL = exp(detransformed_means_table$upper.CL)


detransformed_means_table
means_original

```

> My means in my original data are slightly higher than my means in the de-transformed data. The CI's shifted in a different way, the untransformed data of the untransformed data are somewhat narrower than the original data. See the tables above for the estimates of the CIs. 